# Handover — 2026-02-08 Session

## Summary

This session refactored the MD-to-FB tool's audit system, improved line break handling, and added input highlighting for unconvertible markdown.

---

## Changes Made (All verified: tests pass, build clean)

### 1. Audit System — Simplified to external links only

**Rationale**: Post length, hashtags, engagement bait, allCaps checks were noisy and over-complicated the product. Only external link detection provides actionable value.

**Files changed:**

- **`src/lib/fb-audit.ts`** — Completely rewritten. Exports `hasExternalLinks(text): boolean` and `LINK_PATTERN` (global regex for URL matching). Removed `AuditFinding`, `AuditOptions`, `auditFbPost`, and all check functions (postLength, hashtags, engagementBait, allCaps).

- **`src/lib/__tests__/fb-audit.test.ts`** — Rewritten. 8 tests: `hasExternalLinks` (7) + `LINK_PATTERN` matching (1).

- **`src/components/md-to-fb/AuditPanel.tsx`** — **Deleted**. No longer needed.

- **`src/components/md-to-fb/Editor.tsx`** — External link warning moved to hint area (same row as bold hint, above editor panels). Red banner with `tAudit("externalLinks")`. Passes `highlightLinks` prop to FbPreview. Checks both `markdownInput` AND `fbOutput` for URLs (catches URLs inside backtick code that get Unicode-converted).

- **`src/components/md-to-fb/FbPreview.tsx`** — Added `highlightLinks` prop. When true, URLs in preview text are highlighted with red `<mark>`. Uses `normalizeChar()` to convert Unicode Mathematical Alphanumeric chars (Sans-Serif Bold, Italic, Monospace) back to ASCII before regex matching, then highlights original Unicode text at matched positions.

- **`messages/zh-TW.json`** — Removed: `noIssues`, `postLengthMedium`, `postLengthWithMedia`, `postLengthLong`, `hashtagsModerate`, `hashtagsTooMany`, `engagementBait`, `allCaps`, `hasMediaLabel`, `hasMediaTooltip`, `seeMore`, `fullTextBelow`. Kept: `externalLinks`.

- **`messages/en.json`** — Same removals as zh-TW.

### 2. Line Break Handling — `breaks: true`

**Rationale**: Users paste plain text with single `\n` line breaks. Markdown parser was eating them (treating consecutive lines as same paragraph). Competitor tool (tool.lifehacker.tw/space-converter) preserves line breaks.

**File changed:**

- **`src/lib/fb-renderer.ts`** — Two changes:
  1. Added `br()` renderer returning `"\n"` (preserves single line break, does NOT add blank line)
  2. Added `breaks: true` to `marked.parse()` options

**Behavior:**
- Single `\n` → preserved as line break (no extra spacing)
- `\n\n` (paragraph break) → insertZWSP adds `\u200B` → FB preserves spacing

### 3. Bold/Italic Hint — Fixed scope

**Files changed:**

- **`src/components/md-to-fb/Editor.tsx`** — `STYLED_TEXT_PATTERN` changed from `/(\*\*.+?\*\*|_.+?_|`.+?`)/` to `/(\*\*.+?\*\*|_.+?_)/`. Backtick code no longer triggers the bold hint.

- **`messages/zh-TW.json`** — `boldHint`: "粗體僅適用於英文" → "粗體與斜體僅適用於英文"
- **`messages/en.json`** — `boldHint`: "Bold works on English only" → "Bold and italic work on English only"

### 4. Markdown Input Highlighting — Backdrop overlay for unconvertible CJK

**Rationale**: When `**中文**`, `_中文_`, or `` `中文` `` appears in input, CJK chars won't be converted to Unicode bold/italic/monospace. Highlight to warn user.

**File changed:**

- **`src/components/md-to-fb/MarkdownInput.tsx`** — Added backdrop overlay technique:
  - `buildHighlight(text)` finds markdown markers containing CJK and wraps them in `<mark className="bg-amber-200/70">`
  - Backdrop `<div>` sits behind textarea (`absolute inset-0`, `text-transparent`), only `<mark>` backgrounds visible
  - `syncScroll` callback syncs textarea and backdrop scroll positions
  - Only renders backdrop when `hasUnconvertible` is true (CJK + markdown markers detected)

---

## Current Test Status

- **139 tests passing** across 7 test files
- **Build clean** (Next.js 16.1.6, zero errors)

## Files Summary

| File | Status |
|------|--------|
| `src/lib/fb-audit.ts` | Rewritten (simplified) |
| `src/lib/__tests__/fb-audit.test.ts` | Rewritten |
| `src/lib/fb-renderer.ts` | Modified (breaks + br handler) |
| `src/components/md-to-fb/Editor.tsx` | Modified (audit → inline hint) |
| `src/components/md-to-fb/FbPreview.tsx` | Modified (URL highlight) |
| `src/components/md-to-fb/MarkdownInput.tsx` | Modified (backdrop overlay) |
| `src/components/md-to-fb/AuditPanel.tsx` | **Deleted** |
| `messages/zh-TW.json` | Modified (removed unused keys) |
| `messages/en.json` | Modified (removed unused keys) |

## Known Issues / TODO

1. **Backdrop overlay alignment** — Not yet visually verified in browser. Font metrics (font-mono, text-sm, px-4 py-3) should match textarea exactly, but may need fine-tuning if highlight positions drift.

2. **`hasUnconvertible` check is approximate** — It checks if the entire value has BOTH markdown markers AND CJK, but doesn't verify CJK is specifically *inside* the markers. The `buildHighlight` function does the precise check. This is just a fast-path to avoid rendering the backdrop unnecessarily.

3. **No git commits made** — All changes are unstaged.

---

## Quick Start for Next Session

```bash
cd ~/GitHub/freetools
npx vitest run        # 139 tests
npx next build        # clean
npm run dev           # localhost:3000 → /zh-TW/text/md-to-fb
```

Read this file first: `docs/HANDOVER-20260208.md`
